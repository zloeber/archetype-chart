{{- $root := . -}}
{{- $common := dict "Values" .Values.common -}}
{{- $noCommon := omit .Values "common" -}}
{{- $overrides := dict "Values" $noCommon -}}
{{- $noValues := omit . "Values" -}}
{{- with merge $noValues $overrides $common -}}
{{- $config := .Values.ingress -}}

{{- if and $config.enabled ( eq $config.type "standard" ) }}
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: {{ include "common.shortname" $root }}
  annotations:
{{- if hasKey $config "annotations" }}
    {{- with $config.annotations }}
    {{ toYaml . | nindent 4 }}
    {{- end }}
{{- end }}
{{- include "archetype.ingress.class" $root | nindent 4 }}
{{- include "archetype.certissuer" (list .Values.certIssuerMap .Values.zone) | nindent 4 }}
{{- if $config.forecastle }}
    forecastle.stakater.com/expose: {{ .Values.ingress.forecastle | quote }}
{{- end }}
    service.beta.kubernetes.io/{{ .Values.cloud | default "local" }}-load-balancer-internal: "true"
{{- if $config.prometheusScraped }}
    prometheus.io/scrape: "true"
    prometheus.io/port: {{ $config.prometheusPort | default .Values.ports.prometheus | quote }}
{{- end }}
{{- if $config.enableSSLRedirect }}
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
{{- end }}
{{- if $config.rewrite }}
    ingress.kubernetes.io/rewrite-target: {{ $config.rewriteTarget | default "/" | quote }}
{{- end }}
  labels:
    ingressName: {{ include "common.shortname" $root }}
    {{- include "common.labels" $root | nindent 4 }}
{{- with $config.labels }}
    {{ toYaml . | nindent 4 }}
{{- end }}
spec:
  rules:
{{- range $host := $config.hosts }}
  - host: {{ $host.name | quote }}
{{- if $host.config }}
{{ $host.config | toYaml | indent 4 }}
{{- else }}
{{ include "common.ingress.service" $root | indent 4 }}
{{- end }}
{{- if or $config.tlsEnabled $host.secretName }}
  tls:
    - hosts:
      - {{ $host.name | quote }}
    {{- range $host.additionalhosts }}
      - {{ . }}
    {{- end }}
    {{- if $host.secretName }}
      secretName: {{ $host.secretName }}
    {{- else }}
      secretName: {{ include "common.shortname" $root }}-cert
    {{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end -}}
