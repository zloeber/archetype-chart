{{- $root := . -}}
{{- $ingress := .Values.ingress -}}
{{- if and $ingress.enabled (eq $ingress.type "istio") }}
{{- range $host := $ingress.hosts }}
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
{{- if $host.name }}
  name: {{ $host.name }}
{{- else }}
  name: {{ include "archetype.shortname" $root }}-virtualservice
{{- end }}
spec:
  gateways:
  {{- if $ingress.gateways }}
    {{- with $ingress.gateways }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- else if $ingress.gateway.name }}
    - {{ $ingress.gateway.name }}
  {{- else }}
    - {{ include "archetype.shortname" $root }}-gateway
  {{- end }}
  hosts:
  {{- if $host.hostName }}
    - {{ $host.hostName | quote }}
  {{- else if $host.name }}
    - "{{ $host.name }}.{{ include "archetype.clusterdns" $root }}"
  {{- else }}
    - "{{ include "archetype.appname" $root }}.{{ include "archetype.clusterdns" $root }}"
  {{- end }}
  {{- range $host.additionalHosts }}
    - {{ . }}
  {{- end }}
  http:
{{- if $host.paths }}
  {{- range $hostpath := $host.paths }}
  - match:
    - uri:
        prefix: {{ $hostpath.path | default "/" }}
    route:
    - destination:
      {{- if $hostpath.backend.serviceName }}        
        host: {{ $hostpath.backend.serviceName }}
      {{- else }}
        host: {{ include "archetype.fullname" $root }}
      {{- end }}
        port:
        {{- if $hostpath.backend.servicePort }}        
          number: {{ $hostpath.backend.servicePort }}
        {{- else }}
          number: {{ include "archetype.fullname" $root }}
        {{- end }}
{{- else }}
  {{- include "archetype.istio.virtualservice" $root | nindent 2 }}
{{- end }}
{{- end }}
{{- end }}
{{- end -}}
